name: Kubescape Security Scan

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  YAML_SCAN_OUTPUT: "yaml-scan-results.json"
  CLUSTER_SCAN_OUTPUT: "cluster-scan-results.json"
  NOTIFICATION_RECIPIENTS: "najah.wchem@etudiant-isi.utm.tn, saber.fraj@etudiant-isi.utm.tn"

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Kubescape
        id: install-kubescape
        run: |
          # Installation de Kubescape
          curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
          
          # Ajout au PATH de manière persistante
          echo "$HOME/.kubescape/bin" >> $GITHUB_PATH
          echo "PATH=$PATH:$HOME/.kubescape/bin" >> $GITHUB_ENV
          
          # Vérification de l'installation
          echo "Verifying installation..."
          $HOME/.kubescape/bin/kubescape version

      - name: Verify Kubescape in PATH
        run: |
          echo "Current PATH: $PATH"
          which kubescape || echo "Kubescape not found in PATH"
          kubescape version

      - name: Scan Kubernetes manifests
        id: yaml-scan
        run: |
          kubescape scan *.yaml \
            --format json \
            --output ${{ env.YAML_SCAN_OUTPUT }} \
            || echo "YAML scan completed with exit code $?"
          
          [ -f "${{ env.YAML_SCAN_OUTPUT }}" ] && \
            jq '.' ${{ env.YAML_SCAN_OUTPUT }} > temp.json && \
            mv temp.json ${{ env.YAML_SCAN_OUTPUT }}

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            ${{ env.YAML_SCAN_OUTPUT }}
