name: üîç Analyse de S√©curit√©

on:
  workflow_call:
    secrets:
      EMAIL_FROM:
        required: true
      EMAIL_PWD:
        required: true
      REPORT_TO:
        required: true

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup environment
        run: |
          mkdir -p .github/reports
          echo "$HOME/.kubescape/bin" >> $GITHUB_PATH

      - name: Install Kubescape
        run: |
          curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | bash
          kubescape version

      - name: Find Kubernetes manifests
        id: find-manifests
        run: |
          MANIFESTS=$(find . -name '*.yaml' -o -name '*.yml' | grep -v 'scan-results' | tr '\n' ' ')
          if [ -z "$MANIFESTS" ]; then
            echo "::error::Aucun fichier YAML Kubernetes trouv√©"
            exit 1
          fi
          echo "MANIFESTS=${MANIFESTS}" >> $GITHUB_OUTPUT
          echo "Fichiers √† analyser: ${MANIFESTS}"

      - name: Run Kubescape scan
        run: |
          kubescape scan ${{ steps.find-manifests.outputs.MANIFESTS }} \
            --format json \
            --output .github/reports/scan-results.json || SCAN_FAILED=$?
          
          if [ ! -s ".github/reports/scan-results.json" ]; then
            echo "::error::Le scan n'a produit aucun r√©sultat"
            exit 1
          fi

      - name: Save report
        run: |
          jq '.' .github/reports/scan-results.json # Validation JSON
          cp .github/reports/scan-results.json .github/reports/scan-results-$(date +%Y%m%d-%H%M%S).json

      - name: Send report
        env:
          GMAIL_USER: ${{ secrets.EMAIL_FROM }}
          GMAIL_PASSWORD: ${{ secrets.EMAIL_PWD }}
          REPORT_EMAIL: ${{ secrets.REPORT_TO }}
        run: python .github/scripts/scanning/send-report.py
