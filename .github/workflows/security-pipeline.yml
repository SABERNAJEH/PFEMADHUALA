name: Kubernetes Security Pipeline

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  security-scan:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: 'main-repo'  # NÃ©cessaire pour les actions locales

      - name: Setup Cluster
        uses: ./.github/workflows/actions/cluster-setup
        with:
          minikube_version: 'v1.32.0'

      - name: Deploy Kubernetes Goat
        uses: ./.github/workflows/actions/kubernetes-goat

      - name: Run Security Scan
        uses: ./.github/workflows/actions/kubescape-scan
        with:
          scan_output: 'cluster-scan-results.json'
